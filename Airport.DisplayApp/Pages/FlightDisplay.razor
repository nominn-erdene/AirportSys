@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@using Airport.Core.Models
@using System.Text.Json
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

<div class="flight-board">
    <h1>Flight Information Display</h1>
    <div class="flight-table">
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Flight</th>
                    <th>Destination</th>
                    <th>Gate</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var flight in _flights)
                {
                    <tr class="@GetStatusClass(flight.Status)">
                        <td>@flight.DepartureTime.ToString("HH:mm")</td>
                        <td>@flight.FlightNumber</td>
                        <td>@flight.Destination</td>
                        <td>@flight.Gate</td>
                        <td>@flight.Status.ToString()</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    .flight-board {
        padding: 20px;
        background-color: #1a1a1a;
        color: #fff;
    }

    .flight-table {
        margin-top: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background-color: #000;
    }

    th, td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #333;
    }

    th {
        background-color: #333;
        color: #fff;
    }

    tr {
        transition: background-color 0.3s;
    }

    tr:hover {
        background-color: #2a2a2a;
    }

    .status-boarding {
        background-color: #1a472a;
    }

    .status-delayed {
        background-color: #5c4a1d;
    }

    .status-cancelled {
        background-color: #4a1d1d;
    }

    .status-departed {
        background-color: #1d3a4a;
    }
</style>

@code {
    private HubConnection _hubConnection;
    private List<Flight> _flights = new();
    private readonly HttpClient _httpClient = new();
    private readonly string _apiBaseUrl = "http://localhost:5000/api";

    protected override async Task OnInitializedAsync()
    {
        await FetchFlights();
        await SetupSignalRConnection();
    }

    private async Task FetchFlights()
    {
        try
        {
            var response = await _httpClient.GetAsync($"{_apiBaseUrl}/flights");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                _flights = JsonSerializer.Deserialize<List<Flight>>(content);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching flights: {ex.Message}");
        }
    }

    private async Task SetupSignalRConnection()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/flighthub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<int, FlightStatus>("FlightStatusChanged", async (flightId, newStatus) =>
        {
            var flight = _flights.FirstOrDefault(f => f.Id == flightId);
            if (flight != null)
            {
                flight.Status = newStatus;
                await InvokeAsync(StateHasChanged);
            }
        });

        await _hubConnection.StartAsync();
    }

    private string GetStatusClass(FlightStatus status) => status switch
    {
        FlightStatus.Boarding => "status-boarding",
        FlightStatus.Delayed => "status-delayed",
        FlightStatus.Cancelled => "status-cancelled",
        FlightStatus.Departed => "status-departed",
        _ => ""
    };

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
} 